---
import BlogLayout from '@/layouts/BlogLayout.astro';
import Footer from '@/components/Footer.astro';
import Comment from '@/islands/Comment';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => data.published !== false);
  return posts.map((post) => ({
    params: { slug: post.data.slug || post.id },
    props: { post, allPosts: posts },
  }));
}

const { post, allPosts } = Astro.props;
const { Content } = await render(post);

// Related posts logic
const parseTags = (tag?: string) =>
  (tag ?? '').split(',').map((t) => t.trim()).filter(Boolean);

const currentTags = new Set(parseTags(post.data.tag));
const candidates = allPosts
  .filter((p) => p.id !== post.id)
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

const tagMatched = candidates
  .map((p) => ({
    post: p,
    overlap: parseTags(p.data.tag).filter((t) => currentTags.has(t)).length,
  }))
  .filter(({ overlap }) => overlap > 0)
  .sort((a, b) => b.overlap - a.overlap)
  .map(({ post }) => post);

const sameCategory = candidates.filter((p) => p.data.category === post.data.category);

const seen = new Set<string>();
const relatedPosts = (currentTags.size > 0
  ? [...tagMatched, ...sameCategory, ...candidates]
  : candidates
).filter((p) => {
  if (seen.has(p.id)) return false;
  seen.add(p.id);
  return true;
}).slice(0, 5);

const tags = parseTags(post.data.tag);
const formattedDate = new Date(post.data.date).toLocaleDateString('ko-KR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const slug = post.data.slug || post.id;
const siteOrigin = Astro.site?.origin || 'https://bbinya1224.github.io';
const url = `${siteOrigin}/posts/${slug}`;

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.data.title,
  description: post.data.description,
  datePublished: post.data.date instanceof Date ? post.data.date.toISOString() : String(post.data.date),
  author: {
    '@type': 'Person',
    name: '삔야',
    url: `${siteOrigin}/about-me`,
  },
  publisher: {
    '@type': 'Person',
    name: '삔야',
  },
  image: post.data.thumbnail
    ? `https://bbinya1224.github.io${post.data.thumbnail}`
    : undefined,
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': url,
  },
};
---

<BlogLayout
  title={post.data.title}
  description={post.data.description || post.data.title}
  image={post.data.thumbnail}
  canonicalUrl={url}
  publishedTime={post.data.date instanceof Date ? post.data.date.toISOString() : String(post.data.date)}
  type="article"
>
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <section class="mx-auto h-full w-full max-w-4xl">
    <article class="relative p-4 sm:p-8">
      <header class="mb-6 border-b border-gray-200 pb-4 sm:mb-8 sm:pb-6 dark:border-gray-700">
        <h1 class="relative mb-2 cursor-default text-3xl font-bold before:absolute sm:mb-4 sm:text-4xl md:text-5xl">
          {post.data.title}
        </h1>

        {post.data.description && (
          <p class="mb-2 text-lg text-gray-400">{post.data.description}</p>
        )}

        <div class="flex cursor-default flex-wrap gap-4 text-sm text-gray-600 dark:text-gray-400">
          <div class="flex items-center gap-1">
            <svg class="size-5 text-amber-300" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 10H21M7 3V5M17 3V5M6.2 21H17.8C18.9201 21 19.4802 21 19.908 20.782C20.2843 20.5903 20.5903 20.2843 20.782 19.908C21 19.4802 21 18.9201 21 17.8V8.2C21 7.07989 21 6.51984 20.782 6.09202C20.5903 5.71569 20.2843 5.40973 19.908 5.21799C19.4802 5 18.9201 5 17.8 5H6.2C5.0799 5 4.51984 5 4.09202 5.21799C3.71569 5.40973 3.40973 5.71569 3.21799 6.09202C3 6.51984 3 7.07989 3 8.2V17.8C3 18.9201 3 19.4802 3.21799 19.908C3.40973 20.2843 3.71569 20.5903 4.09202 20.782C4.51984 21 5.07989 21 6.2 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <time datetime={post.data.date instanceof Date ? post.data.date.toISOString() : String(post.data.date)}>{formattedDate}</time>
          </div>

          {post.data.category && (
            <div class="flex cursor-default items-center gap-1">
              <svg class="size-5 text-amber-300" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19.8978 16H7.89778C6.96781 16 6.50282 16 6.12132 16.1022C5.08604 16.3796 4.2774 17.1883 4 18.2235" stroke="currentColor" stroke-width="1.5"/>
                <path d="M7 16V2.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                <path d="M10 22C7.17157 22 5.75736 22 4.87868 21.1213C4 20.2426 4 18.8284 4 16V8C4 5.17157 4 3.75736 4.87868 2.87868C5.75736 2 7.17157 2 10 2H14C16.8284 2 18.2426 2 19.1213 2.87868C20 3.75736 20 5.17157 20 8M14 22C16.8284 22 18.2426 22 19.1213 21.1213C20 20.2426 20 18.8284 20 16V12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
              <span>{post.data.category}</span>
            </div>
          )}

          {tags.length > 0 && (
            <div class="flex cursor-default items-center gap-1">
              <svg class="size-5 text-amber-300" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.0498 7.0498H7.0598M10.5118 3H7.8C6.11984 3 5.27976 3 4.63803 3.32698C4.07354 3.6146 3.6146 4.07354 3.32698 4.63803C3 5.27976 3 6.11984 3 7.8V10.5118C3 11.2455 3 11.6124 3.08289 11.9577C3.15638 12.2638 3.27759 12.5564 3.44208 12.8249C3.6276 13.1276 3.88703 13.387 4.40589 13.9059L9.10589 18.6059C10.2939 19.7939 10.888 20.388 11.5729 20.6105C12.1755 20.8063 12.8245 20.8063 13.4271 20.6105C14.112 20.388 14.7061 19.7939 15.8941 18.6059L18.6059 15.8941C19.7939 14.7061 20.388 14.112 20.6105 13.4271C20.8063 12.8245 20.8063 12.1755 20.6105 11.5729C20.388 10.888 19.7939 10.2939 18.6059 9.10589L13.9059 4.40589C13.387 3.88703 13.1276 3.6276 12.8249 3.44208C12.5564 3.27759 12.2638 3.15638 11.9577 3.08289C11.6124 3 11.2455 3 10.5118 3ZM7.5498 7.0498C7.5498 7.32595 7.32595 7.5498 7.0498 7.5498C6.77366 7.5498 6.5498 7.32595 6.5498 7.0498C6.5498 6.77366 6.77366 6.5498 7.0498 6.5498C7.32595 6.5498 7.5498 6.77366 7.5498 7.0498Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>{tags.join(', ')}</span>
            </div>
          )}
        </div>
      </header>

      <div class="prose dark:prose-invert max-w-none">
        <Content />
      </div>

      {relatedPosts.length > 0 && (
        <section class="mt-12 border-t border-gray-200 pt-8 dark:border-gray-700">
          <h2 class="mb-4 text-xl font-semibold text-gray-900 dark:text-gray-100">관련 글</h2>
          <ul class="space-y-3">
            {relatedPosts.map((related) => (
              <li>
                <a
                  href={`/posts/${related.data.slug || related.id}`}
                  class="text-base text-gray-700 hover:text-amber-500 dark:text-gray-300 dark:hover:text-amber-400"
                >
                  {related.data.title}
                </a>
              </li>
            ))}
          </ul>
        </section>
      )}

      <Comment client:idle />
    </article>
  </section>
</BlogLayout>
