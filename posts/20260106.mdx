---
title: "Next.js App Router í™˜ê²½ì—ì„œì˜ i18n Provider êµ¬í˜„: ê¹œë¹¡ì„ê³¼ Race Condition í•´ê²°"
date: "2026-01-06"
slug: "20260106"
description: "Server Component íŒ¨í„´ìœ¼ë¡œ UX ê°œì„ ê³¼ ë™ì‹œì„± ì´ìŠˆë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•ì„ ì¸í„°ë™í‹°ë¸Œ ë°ëª¨ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤."
category: "Frontend"
tag: "Next.js, i18n, Server Components, Concurrency"
thumbnail: ""
---

import FlickeringDemo from "@/widgets/lab/ui/flickering-demo/FlickeringDemo";
import RaceConditionDemo from "@/widgets/lab/ui/race-condition/RaceConditionDemo";

> Next.js App Router í™˜ê²½ì—ì„œ i18n Providerë¥¼ êµ¬í˜„í•  ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë‘ ê°€ì§€ ì£¼ìš” ë¬¸ì œì™€ í•´ê²° ë°©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤.

**ë¬¸ì œì **
- **í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì–¸ì–´ ê°ì§€** â†’ í™”ë©´ ê¹œë¹¡ì„, Hydration ë¶ˆì¼ì¹˜
- **ì„œë²„ ì‚¬ì´ë“œ ì‹±ê¸€í†¤** â†’ Race Condition (ë™ì‹œì„± ì´ìŠˆ)

**í•´ê²°ì±…**
- **Server Componentì—ì„œ ì–¸ì–´ ê²°ì •** â†’ Clientì— Props ì „ë‹¬
- **ìš”ì²­ë³„ ì¸ìŠ¤í„´ìŠ¤ ê²©ë¦¬** â†’ ë™ì‹œ ì ‘ì† ì‚¬ìš©ì ê°„ ë°ì´í„° ê²©ë¦¬ ë³´ì¥

ì•„ë˜ ì¸í„°ë™í‹°ë¸Œ ë°ëª¨ë¡œ ê° íŒ¨í„´ì˜ ë™ì‘ì„ ì§ì ‘ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ë°°ê²½: ê¸°ì¡´ ì•„í‚¤í…ì²˜ ë¶„ì„

Next.js App Routerë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ë©´ì„œ ê¸°ì¡´ CSR ê¸°ë°˜ i18n êµ¬í˜„ì„ ê²€í† í•˜ë˜ ì¤‘, ë‘ ê°€ì§€ êµ¬ì¡°ì  ë¬¸ì œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.

### ê¸°ì¡´ êµ¬í˜„ ë°©ì‹

```tsx
// Client Componentì—ì„œ ì–¸ì–´ ê°ì§€
'use client';

const TranslationProvider = ({ children }) => {
  const [locale, setLocale] = useState('en');

  useEffect(() => {
    const subdomain = window.location.hostname.split('.')[0];
    const detectedLocale = i18nConfig.locales.includes(subdomain)
      ? subdomain
      : i18nConfig.defaultLocale;

    setLocale(detectedLocale);
  }, []);

  return <I18nextProvider i18n={i18nInstance}>{children}</I18nextProvider>;
};
```

### ë°œê²¬ëœ ë¬¸ì œ

1. **í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì–¸ì–´ ê°ì§€**
   - ì„œë²„ ë Œë”ë§ê³¼ í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸° ë Œë”ë§ ê°„ ë¶ˆì¼ì¹˜
   - useEffect ì‹¤í–‰ í›„ ì¶”ê°€ ë¦¬ë Œë”ë§ ë°œìƒ
   - Hydration Mismatch ê²½ê³ 

2. **ì„œë²„ ì‚¬ì´ë“œ ì‹±ê¸€í†¤ íŒ¨í„´**
   - ëª¨ë“ˆ ë ˆë²¨ì—ì„œ i18n ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
   - ëª¨ë“  ìš”ì²­ì´ ë™ì¼í•œ ì¸ìŠ¤í„´ìŠ¤ ê³µìœ 
   - ë™ì‹œ ìš”ì²­ ì‹œ ë°ì´í„° ì˜¤ì—¼ ê°€ëŠ¥ì„± (Race Condition)

ì´ ë¬¸ì œë“¤ì€ íŠ¹íˆ **íŠ¸ë˜í”½ì´ ì¦ê°€í•  ë•Œ ë‘ë“œëŸ¬ì§€ëŠ” íŠ¹ì§•** ì´ ìˆìŠµë‹ˆë‹¤.  
ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œëŠ” ë‹¨ì¼ ì‚¬ìš©ìë§Œ í…ŒìŠ¤íŠ¸í•˜ê¸° ë•Œë¬¸ì— ë°œê²¬í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤.

---

## Server Components íŒ¨í„´ ì´í•´í•˜ê¸°

ë¬¸ì œë¥¼ íŒŒí—¤ì¹˜ê¸° ì „ì—, Next.js App Routerì˜ í•µì‹¬ ê°œë…ì¸ **Server Components**ë¥¼ ë¨¼ì € ì´í•´í•´ì•¼ í•©ë‹ˆë‹¤.

### Client vs Server: ëˆ„ê°€ ë¬´ì—‡ì„ ì•Œ ìˆ˜ ìˆë‚˜?

| êµ¬ë¶„ | Client Component | Server Component |
|------|------------------|------------------|
| **ì‹¤í–‰ í™˜ê²½** | ë¸Œë¼ìš°ì € | Node.js ì„œë²„ |
| **ì ‘ê·¼ ê°€ëŠ¥ ì •ë³´** | `window`, `localStorage`, DOM | ìš”ì²­ í—¤ë”, ì¿ í‚¤, íŒŒì¼ ì‹œìŠ¤í…œ, DB |
| **ë Œë”ë§ ì‹œì ** | Hydration í›„ | ìš”ì²­ ì‹œì  |
| **ì‚¬ìš© ì˜ˆì‹œ** | ì¸í„°ë™ì…˜, ì• ë‹ˆë©”ì´ì…˜ | ë°ì´í„° í˜ì¹­, ì´ˆê¸° ì„¤ì • |

<aside data-type="info">
í•µì‹¬ì€ **ì„œë²„ê°€ ë¨¼ì €, í´ë¼ì´ì–¸íŠ¸ëŠ” ë‚˜ì¤‘ì—** ë¼ëŠ” ì !
</aside>

```tsx
// âœ… Server Componentì—ì„œ ê²°ì • â†’ Clientì— ì „ë‹¬
// app/layout.tsx (Server Component)
const RootLayout = async ({ children }) => {
  // ì„œë²„ì—ì„œ ìš”ì²­ í—¤ë”ë¥¼ ë³´ê³  ì–¸ì–´ ê²°ì •
  const lang = await getLanguageFromHeaders();

  return (
    <html lang={lang}>
      <body>
        {/* Client Componentì— Propsë¡œ ì „ë‹¬ */}
        <I18nProvider initialLocale={lang}>
          {children}
        </I18nProvider>
      </body>
    </html>
  );
};
```

```tsx
// âŒ Client Componentì—ì„œ ê²°ì •
// app/provider/TranslationProvider.tsx (Client Component)
'use client';

const TranslationProvider = ({ children }) => {
  // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë¸Œë¼ìš°ì € ì •ë³´ë¥¼ ë³´ê³  ì–¸ì–´ ê²°ì •
  useEffect(() => {
    const lang = window.location.hostname.split('.')[0];
    setLocale(lang); // ë¬¸ì œ ë°œìƒ!
  }, []);

  return <I18nextProvider i18n={i18n}>{children}</I18nextProvider>;
};
```

ë‘ ë²ˆì§¸ íŒ¨í„´ì˜ ë¬¸ì œì ì€ ë‹¤ìŒ ì„¹ì…˜ì—ì„œ ì¸í„°ë™í‹°ë¸Œ ë°ëª¨ì™€ í•¨ê»˜ ì„¤ëª…í•©ë‹ˆë‹¤.

---

## ğŸ® ì²´í—˜í•´ë³´ê¸°: ê¹œë¹¡ì„ ë°ëª¨

ì•„ë˜ ë°ëª¨ì—ì„œ useEffect ë°©ì‹ê³¼ Server Props ë°©ì‹ì˜ ë Œë”ë§ ì°¨ì´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<FlickeringDemo client:only="react" />

## ë¬¸ì œ 1: useEffect ê¸°ë°˜ ì–¸ì–´ ê°ì§€ì˜ UX ë¬¸ì œ

ìœ„ ë°ëª¨ì—ì„œ í™•ì¸í–ˆë“¯ì´, `useEffect` ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œë¥¼ ì¼ìœ¼í‚µë‹ˆë‹¤.

### ì‹¤í–‰ ìˆœì„œ ë¶„ì„

```
1. ì„œë²„: ê¸°ë³¸ ì–¸ì–´('en')ë¡œ HTML ìƒì„±
2. í´ë¼ì´ì–¸íŠ¸: HTML ìˆ˜ì‹  ë° í™”ë©´ í‘œì‹œ ('en' ì½˜í…ì¸  ë³´ì„)
3. React Hydration ì‹œì‘
4. useEffect ì‹¤í–‰ (í˜¸ìŠ¤íŠ¸ë„¤ì„ íŒŒì‹±)
5. ì–¸ì–´ ë³€ê²½ ê°ì§€ ('en' â†’ 'ko')
6. setLocale('ko') í˜¸ì¶œ
7. ë¦¬ë Œë”ë§ â†’ í™”ë©´ ê¹œë¹¡ì„!  âš ï¸
```

### ì‚¬ìš©ìê°€ ë³´ëŠ” ê²ƒ

```
ì²˜ìŒ í™”ë©´: "Welcome to our site" (ì˜ì–´)
        â†“ (0.1ì´ˆ í›„)
ê¹œë¹¡ì„ í›„: "ì‚¬ì´íŠ¸ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤" (í•œêµ­ì–´)
```

### ì¶”ê°€ ë¬¸ì œë“¤

#### 1. **Hydration Mismatch ê²½ê³ **

```
Warning: Text content did not match.
Server: "Welcome" Client: "í™˜ì˜í•©ë‹ˆë‹¤"
```

ì„œë²„ê°€ ìƒì„±í•œ HTMLê³¼ í´ë¼ì´ì–¸íŠ¸ì˜ ì´ˆê¸° ë Œë”ë§ ê²°ê³¼ê°€ ë‹¬ë¼ Reactê°€ ê²½ê³ ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.

#### 2. **ë¡œì§ ì¤‘ë³µ**

```tsx
// ì„œë²„ ì¸¡: app/[locale]/layout.tsx
const serverLocale = await getLanguage();

// í´ë¼ì´ì–¸íŠ¸ ì¸¡: TranslationProvider.tsx
useEffect(() => {
  const clientLocale = location.hostname?.split('.')[0];
  // ê°™ì€ ë¡œì§ì´ ë‘ ê³³ì— ì¡´ì¬!
}, []);
```

---

## í•´ê²° 1: Server-to-Client ë°ì´í„° ì „ë‹¬ íŒ¨í„´

### í•µì‹¬ ì•„ì´ë””ì–´

> **"ì„œë²„ê°€ ì•Œì•„ì„œ ê²°ì •í•˜ê³ , í´ë¼ì´ì–¸íŠ¸ëŠ” ë°›ì•„ì„œ ì“°ê¸°ë§Œ í•œë‹¤"**

### âœ… ê°œì„ ëœ ì½”ë“œ

#### Step 1: ì„œë²„ì—ì„œ ì–¸ì–´ ê²°ì •

```tsx
// app/layout.tsx (Server Component)
import { getLanguage } from '@/shared/i18n';
import TranslationProvider from '@/app/provider/TranslationProvider';

const RootLayout = async ({ children }: { children: React.ReactNode }) => {
  // ì„œë²„ì—ì„œ ì–¸ì–´ ë¯¸ë¦¬ ê°€ì ¸ì˜¤ê¸° (ìš”ì²­ í—¤ë” ê¸°ë°˜)
  const lang = await getLanguage();

  return (
    <html lang={lang}>
      <body>
        {/* Client Componentì— propsë¡œ ì „ë‹¬ */}
        <TranslationProvider initialLocale={lang}>
          {children}
        </TranslationProvider>
      </body>
    </html>
  );
};

export default RootLayout;
```

#### Step 2: í´ë¼ì´ì–¸íŠ¸ëŠ” ë°›ì•„ì„œ ì‚¬ìš©

```tsx
// app/provider/TranslationProvider.tsx (Client Component)
'use client';

import { useRef } from 'react';
import { I18nextProvider } from 'react-i18next';
import initTranslations, { createTranslationInstance } from '@/shared/i18n/lib/initTranslation';

const instance = createTranslationInstance();

type TranslationProviderProps = {
  children: React.ReactNode;
  initialLocale: string; // ì„œë²„ë¡œë¶€í„° ì „ë‹¬ë°›ìŒ
};

const TranslationProvider = ({ children, initialLocale }: TranslationProviderProps) => {
  const isInitialized = useRef(false);

  // ë Œë”ë§ ì¤‘ ì´ˆê¸°í™” (useEffect ì œê±°)
  if (!isInitialized.current) {
    initTranslations(instance, {
      locale: initialLocale,
      namespaces: ['common'],
      // ...
    });
    isInitialized.current = true;
  }

  return <I18nextProvider i18n={instance}>{children}</I18nextProvider>;
};

export default TranslationProvider;
```

### ê°œì„  íš¨ê³¼

| í•­ëª© | AS-IS | TO-BE |
|------|-------|-------|
| **ì´ˆê¸° ë Œë”ë§** | ì˜ì–´ â†’ ê¹œë¹¡ì„ â†’ í•œêµ­ì–´ | ì²˜ìŒë¶€í„° í•œêµ­ì–´ |
| **Hydration** | Mismatch ê²½ê³  ë°œìƒ | ì¼ì¹˜ |
| **ë¦¬ë Œë”ë§** | 2ë²ˆ (ì´ˆê¸° + useEffect í›„) | 1ë²ˆ |
| **ë¡œì§ ìœ„ì¹˜** | ì„œë²„ + í´ë¼ì´ì–¸íŠ¸ ì¤‘ë³µ | ì„œë²„ë§Œ |

---

## ì„œë²„ ì‚¬ì´ë“œì˜ íŠ¹ìˆ˜ì„±: ë©”ëª¨ë¦¬ëŠ” ê³µìœ ëœë‹¤

í´ë¼ì´ì–¸íŠ¸ ì¸¡ ë¬¸ì œë¥¼ í•´ê²°í–ˆìœ¼ë‹ˆ ëì¼ê¹Œìš”? ì•„ë‹™ë‹ˆë‹¤.
ì„œë²„ ì‚¬ì´ë“œ ë Œë”ë§(SSR)ì„ ìœ„í•œ ì½”ë“œë¥¼ ë¦¬ë·°í•˜ë˜ ì¤‘, í›¨ì”¬ ë” ì¹˜ëª…ì ì¸ ë¬¸ì œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.

### ì¤‘ìš”í•œ ì°¨ì´: Client vs Serverì˜ ë©”ëª¨ë¦¬ ëª¨ë¸

```tsx
// âœ… Client Component (ì•ˆì „)
const instance = createTranslationInstance(); // ë¸Œë¼ìš°ì €ë§ˆë‹¤ ë…ë¦½

const TranslationProvider = ({ children }) => {
  return <I18nextProvider i18n={instance}>{children}</I18nextProvider>;
};
```

```tsx
// âŒ Server Function (ìœ„í—˜)
const instance = createTranslationInstance(); // ëª¨ë“  ìš”ì²­ì´ ê³µìœ 

export async function getServerTranslation() {
  // ëª¨ë“  ì‚¬ìš©ìê°€ ê°™ì€ instanceë¥¼ ì‚¬ìš©!
}
```

### ì™œ ë‹¤ë¥¼ê¹Œìš”?

| í™˜ê²½ | ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ | ëª¨ë“ˆ ë ˆë²¨ ë³€ìˆ˜ |
|------|-------------|--------------|
| **Browser** | ê° ì‚¬ìš©ìì˜ ë¸Œë¼ìš°ì € | ë…ë¦½ (ê° ë¸Œë¼ìš°ì €ë§ˆë‹¤ ìƒˆë¡œ ìƒì„±) |
| **Node.js Server** | ë‹¨ì¼ Node.js í”„ë¡œì„¸ìŠ¤ | ê³µìœ  (ëª¨ë“  ìš”ì²­ì´ í•¨ê»˜ ì‚¬ìš©) |


```
ë¸Œë¼ìš°ì € í™˜ê²½:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ë¯¸êµ­ ìœ ì €ì˜ Chrome    í•œêµ­ ìœ ì €ì˜ Safari
    â†“                    â†“
  instance_A           instance_B
    (ë…ë¦½)               (ë…ë¦½)

ì„œë²„ í™˜ê²½:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Node.js í”„ë¡œì„¸ìŠ¤ (ë‹¨ í•˜ë‚˜!)
         â†“
     instance (ê³µìœ !)
       â†™   â†˜
  ë¯¸êµ­ ìœ ì €  í•œêµ­ ìœ ì €
    (ì¶©ëŒ!)
```

---

## ğŸ® ì²´í—˜í•´ë³´ê¸°: Race Condition ì‹œë®¬ë ˆì´í„°

ì•„ë˜ ë°ëª¨ì—ì„œ ì‹±ê¸€í†¤ íŒ¨í„´ê³¼ ê²©ë¦¬ íŒ¨í„´ì˜ ë™ì‘ ì°¨ì´ë¥¼ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**"ì‹±ê¸€í†¤ (ìœ„í—˜)"** ëª¨ë“œë¡œ ì‹œë®¬ë ˆì´ì…˜ì„ ì‹¤í–‰í•˜ë©´ ë™ì‹œì„± ì´ìŠˆê°€ ë°œìƒí•˜ëŠ” ê³¼ì •ì„ íƒ€ì„ë¼ì¸ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<RaceConditionDemo client:load />

---

## ë¬¸ì œ 2: ì„œë²„ ì‚¬ì´ë“œ ì‹±ê¸€í†¤ì˜ ë™ì‹œì„± ì´ìŠˆ

ìœ„ ë°ëª¨ì—ì„œ í™•ì¸í–ˆë“¯ì´, ì„œë²„ ì‚¬ì´ë“œ ì‹±ê¸€í†¤ì€ **Race Condition**ì„ ì¼ìœ¼í‚µë‹ˆë‹¤.

```tsx
// shared/i18n/server/getServerTranslation.ts

// ğŸ”´ íŒŒì¼ ìµœìƒë‹¨ (Global Scope)
const i18n = createTranslationInstance(); // ëª¨ë“  ìš”ì²­ì´ ì´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê³µìœ !

const getServerTranslation = async () => {
  const locale = await getLanguage();

  // ğŸ”´ ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ì˜ ì–¸ì–´ë¥¼ ê³„ì† ë³€ê²½í•¨
  await initTranslations(i18n, {
    locale,
    namespaces: ['common'],
    // ...
  });

  return {
    i18n,
    t: i18n.getFixedT(locale),
    // ...
  };
};
```

### ë²„ê·¸ ì‹œë‚˜ë¦¬ì˜¤ (ìœ„ ë°ëª¨ì™€ ë™ì¼)

```
íƒ€ì„ë¼ì¸:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

t=0ms    | ë¯¸êµ­ ìœ ì €(A) ìš”ì²­ ì‹œì‘
         | â†’ i18n.changeLanguage('en') í˜¸ì¶œ
         |
t=10ms   | í•œêµ­ ìœ ì €(B) ìš”ì²­ ì‹œì‘
         | â†’ i18n.changeLanguage('ko') í˜¸ì¶œ
         | â†’ ğŸ”´ i18n ì¸ìŠ¤í„´ìŠ¤ê°€ 'ko'ë¡œ ë®ì–´ì”Œì›Œì§!
         |
t=15ms   | Aì˜ ë Œë”ë§ ì™„ë£Œ â†’ ë°˜í™˜
         | â†’ ğŸ”´ ë¯¸êµ­ ìœ ì €ì—ê²Œ í•œêµ­ì–´ ì½˜í…ì¸  ì „ë‹¬! ğŸ’¥
         |
t=20ms   | Bì˜ ë Œë”ë§ ì™„ë£Œ â†’ ë°˜í™˜
         | â†’ í•œêµ­ ìœ ì €ì—ê²Œ í•œêµ­ì–´ ì „ë‹¬ (ì •ìƒ)
```

### ì˜ˆìƒë˜ëŠ” ì¦ìƒ

1. **ê°„í—ì ì¸ ì–¸ì–´ ì˜¤ë¥˜**: íŠ¹ì • ìš”ì²­ì—ì„œ ì˜ëª»ëœ ì–¸ì–´ ë°ì´í„° ë°˜í™˜
2. **ì¬í˜„ ì–´ë ¤ì›€**: ë™ì‹œ ìš”ì²­ì´ ì—†ëŠ” í™˜ê²½(ë¡œì»¬ ê°œë°œ)ì—ì„œëŠ” ë°œìƒí•˜ì§€ ì•ŠìŒ
3. **íŠ¸ë˜í”½ ì˜ì¡´ì„±**: ë™ì‹œ ì ‘ì† ì‚¬ìš©ìê°€ ë§ì„ìˆ˜ë¡ ë°œìƒ í™•ë¥  ì¦ê°€

ì´ëŸ¬í•œ íŠ¹ì„± ë•Œë¬¸ì— í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ë””ë²„ê¹…ì´ ë§¤ìš° ì–´ë µìŠµë‹ˆë‹¤.

---

## í•´ê²° 2: ìš”ì²­ë³„ ì¸ìŠ¤í„´ìŠ¤ ê²©ë¦¬

```tsx
// shared/i18n/server/getServerTranslation.ts

// ğŸŸ¢ ëª¨ë“ˆ ë ˆë²¨ì—ì„œëŠ” ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ì§€ ì•ŠìŒ!

const getServerTranslation = async () => {
  const locale = await getLanguage();

  // ğŸŸ¢ ìš”ì²­ë§ˆë‹¤ ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
  const i18n = createTranslationInstance();

  // ì´ ì¸ìŠ¤í„´ìŠ¤ëŠ” í˜„ì¬ ìš”ì²­ì—ë§Œ ì†í•¨
  await initTranslations(i18n, {
    locale,
    namespaces: ['common'],
    // ...
  });

  return {
    i18n,
    t: i18n.getFixedT(locale),
    resources: i18n.services.resourceStore.data,
  };
};

export default getServerTranslation;
```

### ê°œì„  í›„ ì‹œë‚˜ë¦¬ì˜¤

```
íƒ€ì„ë¼ì¸:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

t=0ms    | ë¯¸êµ­ ìœ ì €(A) ìš”ì²­ ì‹œì‘
         | â†’ i18n_A = createTranslationInstance()
         | â†’ i18n_A.changeLanguage('en')
         |
t=10ms   | í•œêµ­ ìœ ì €(B) ìš”ì²­ ì‹œì‘
         | â†’ i18n_B = createTranslationInstance()
         | â†’ i18n_B.changeLanguage('ko')
         | â†’ âœ… Aì™€ BëŠ” ì™„ì „íˆ ë…ë¦½ëœ ì¸ìŠ¤í„´ìŠ¤!
         |
t=15ms   | Aì˜ ë Œë”ë§ ì™„ë£Œ â†’ i18n_A ì‚¬ìš©
         | â†’ âœ… ë¯¸êµ­ ìœ ì €ì—ê²Œ ì˜ì–´ ì „ë‹¬
         |
t=20ms   | Bì˜ ë Œë”ë§ ì™„ë£Œ â†’ i18n_B ì‚¬ìš©
         | â†’ âœ… í•œêµ­ ìœ ì €ì—ê²Œ í•œêµ­ì–´ ì „ë‹¬
```

---

## Providerì— ì ìš©í•˜ê¸°

ì•ì„œ ì„¤ëª…í•œ ë‘ ê°€ì§€ í•´ê²°ì±…ì„ ì‹¤ì œ i18n Provider êµ¬í˜„ì— ì ìš©í•©ë‹ˆë‹¤.

### ìµœì¢… ì•„í‚¤í…ì²˜

```
app/
â”œâ”€â”€ layout.tsx                     # Server Component (ì–¸ì–´ ê²°ì •)
â””â”€â”€ provider/
    â””â”€â”€ TranslationProvider.tsx    # Client Component (ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”)

shared/
â””â”€â”€ i18n/
    â”œâ”€â”€ server/
    â”‚   â”œâ”€â”€ getLanguage.ts         # ì„œë²„ ì „ìš©: ì–¸ì–´ ê°ì§€
    â”‚   â””â”€â”€ getServerTranslation.ts # ì„œë²„ ì „ìš©: SSR ë²ˆì—­
    â””â”€â”€ lib/
        â””â”€â”€ initTranslation.ts     # ì´ˆê¸°í™” í•¨ìˆ˜
```

### ì „ì²´ ì½”ë“œ

#### 1. Server Component - ì–¸ì–´ ê²°ì •

```tsx
// app/layout.tsx
import { getLanguage } from '@/shared/i18n/server/getLanguage';
import TranslationProvider from '@/app/provider/TranslationProvider';

const RootLayout = async ({ children }: { children: React.ReactNode }) => {
  const lang = await getLanguage();

  return (
    <html lang={lang}>
      <body>
        <TranslationProvider initialLocale={lang}>
          {children}
        </TranslationProvider>
      </body>
    </html>
  );
};

export default RootLayout;
```

#### 2. ì–¸ì–´ ê°ì§€ ë¡œì§ (ì„œë²„ ì „ìš©)

```tsx
// shared/i18n/server/getLanguage.ts
import { headers } from 'next/headers';
import { i18nConfig, type Locales } from '@/app/i18n/config';

export const getLanguage = async (): Promise<Locales> => {
  const headersList = await headers();
  const host = headersList.get('host') || '';

  // Subdomainì—ì„œ ì–¸ì–´ ì¶”ì¶œ (ì˜ˆ: ko.example.com â†’ ko)
  const subdomain = host.split('.')[0];

  const resolvedLocale = i18nConfig.locales.includes(subdomain as Locales)
    ? (subdomain as Locales)
    : i18nConfig.defaultLocale;

  return resolvedLocale;
};
```

#### 3. Client Provider - ì´ˆê¸°í™”

```tsx
// app/provider/TranslationProvider.tsx
'use client';

import { useRef } from 'react';
import { I18nextProvider } from 'react-i18next';
import initTranslations, { createTranslationInstance } from '@/shared/i18n/lib/initTranslation';

const instance = createTranslationInstance();

type TranslationProviderProps = {
  children: React.ReactNode;
  initialLocale: string;
};

const TranslationProvider = ({ children, initialLocale }: TranslationProviderProps) => {
  const isInitialized = useRef(false);

  if (!isInitialized.current) {
    initTranslations(instance, {
      locale: initialLocale,
      namespaces: ['common'],
      // ...
    });
    isInitialized.current = true;
  }

  return <I18nextProvider i18n={instance}>{children}</I18nextProvider>;
};

export default TranslationProvider;
```

#### 4. ì„œë²„ ì‚¬ì´ë“œ ë²ˆì—­ (SSR)

```tsx
// shared/i18n/server/getServerTranslation.ts
import { getLanguage } from './getLanguage';
import initTranslations, { createTranslationInstance } from '../lib/initTranslation';

const getServerTranslation = async () => {
  const locale = await getLanguage();

  // ğŸŸ¢ ìš”ì²­ë§ˆë‹¤ ìƒˆ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
  const i18n = createTranslationInstance();

  const result = await initTranslations(i18n, {
    locale,
    namespaces: ['common'],
    // ...
  });

  return result;
};

export default getServerTranslation;
```

### Before/After ë¹„êµí‘œ

| êµ¬ë¶„ | Before | After |
|------|--------|-------|
| **ì–¸ì–´ ê²°ì • ìœ„ì¹˜** | Client (useEffect) | Server (layout.tsx) |
| **ì´ˆê¸° ë Œë”ë§** | ì˜ì–´ â†’ ê¹œë¹¡ì„ â†’ í•œêµ­ì–´ | ì²˜ìŒë¶€í„° ì˜¬ë°”ë¥¸ ì–¸ì–´ |
| **Hydration** | Mismatch ë°œìƒ | ì¼ì¹˜ |
| **ì„œë²„ ì¸ìŠ¤í„´ìŠ¤** | ì‹±ê¸€í†¤ (ê³µìœ ) | ìš”ì²­ë³„ ìƒì„± |
| **ë™ì‹œì„± ì•ˆì •ì„±** | Race Condition | ê²©ë¦¬ ë³´ì¥ |
| **ì½”ë“œ ì¤‘ë³µ** | ì„œë²„ + í´ë¼ì´ì–¸íŠ¸ ì¤‘ë³µ | ì„œë²„ë§Œ |

---

## ì •ë¦¬

### í•µì‹¬ ì›ì¹™

Next.js App Router í™˜ê²½ì—ì„œ i18n Providerë¥¼ êµ¬í˜„í•  ë•Œ ë‹¤ìŒ ì›ì¹™ì„ ì§€ì¼œì•¼ í•©ë‹ˆë‹¤.

1. **Server Components ìš°ì„  ì„¤ê³„**
   - ìš”ì²­ ì»¨í…ìŠ¤íŠ¸(í—¤ë”, ì¿ í‚¤ ë“±)ëŠ” ì„œë²„ì—ì„œ ì²˜ë¦¬
   - í´ë¼ì´ì–¸íŠ¸ëŠ” ì„œë²„ë¡œë¶€í„° ì „ë‹¬ë°›ì€ ë°ì´í„° ì‚¬ìš©
   - useEffect ê¸°ë°˜ ì´ˆê¸°í™” ì§€ì–‘

2. **ì„œë²„ ì‚¬ì´ë“œ ê²©ë¦¬ ë³´ì¥**
   - ëª¨ë“ˆ ë ˆë²¨ ìƒíƒœ ë³€ìˆ˜ ì‚¬ìš© ê¸ˆì§€
   - ìš”ì²­ë§ˆë‹¤ ë…ë¦½ëœ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
   - Node.jsì˜ ì‹±ê¸€ í”„ë¡œì„¸ìŠ¤ íŠ¹ì„± ê³ ë ¤

3. **íƒ€ì… ì•ˆì •ì„± í™•ë³´**
   - Propsë¥¼ í†µí•œ ëª…ì‹œì  ë°ì´í„° ì „ë‹¬
   - ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ ê°„ ê³„ì•½ ëª…í™•í™”

### Before/After ìš”ì•½

| í•­ëª© | Before | After |
|------|--------|-------|
| **ì–¸ì–´ ê²°ì •** | Client (useEffect) | Server (layout.tsx) |
| **ë Œë”ë§** | 2íšŒ (ì´ˆê¸° + ì¬ë Œë”ë§) | 1íšŒ |
| **Hydration** | Mismatch ë°œìƒ | ì¼ì¹˜ |
| **ì„œë²„ ì¸ìŠ¤í„´ìŠ¤** | ì‹±ê¸€í†¤ (ê³µìœ ) | ìš”ì²­ë³„ ìƒì„± |
| **ë™ì‹œì„±** | Race Condition ê°€ëŠ¥ | ê²©ë¦¬ ë³´ì¥ |

---

## ì°¸ê³  ìë£Œ

### ê´€ë ¨ ê¸€
### Next.js ê³µì‹ ë¬¸ì„œ
- [Server and Client Components](https://nextjs.org/docs/app/building-your-application/rendering/server-components)
- [Server Actions and Mutations](https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations)
- [Headers and Cookies](https://nextjs.org/docs/app/api-reference/functions/headers)

### i18next ë¬¸ì„œ
- [i18next - createInstance](https://www.i18next.com/overview/api#createinstance)
- [react-i18next - SSR](https://react.i18next.com/latest/ssr)

### Node.js ë™ì‹œì„±
- [Node.js Event Loop](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)
- [Understanding Node.js Concurrency Model](https://nodejs.org/en/docs/guides/dont-block-the-event-loop/)

